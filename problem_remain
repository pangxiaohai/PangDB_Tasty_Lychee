Debug double free memory problem.

Refactor duplicated code.
